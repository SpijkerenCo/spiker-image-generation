# Complete Deployment Strategy

## Two Separate Deployments

Your app requires **TWO separate deployments**:

### 1. Frontend (Railway)
- Hosts your React/Vite app
- Serves static HTML/CSS/JS files
- URL: `https://your-app.railway.app`

### 2. Backend (Convex)
- Hosts your backend functions
- Handles auth, database, real-time
- URL: `https://your-deployment.convex.cloud`

## Deployment Workflow

### Step 1: Deploy Convex Backend (First Time)

```bash
# 1. Login to Convex
convex login

# 2. Deploy to production
convex deploy --prod

# Output:
# ✔ Deployed functions to production
# Production URL: https://happy-animal-123.convex.cloud
```

**Copy this URL!** You'll need it for Railway.

### Step 2: Configure Railway Environment Variables

In Railway dashboard → Your Project → Variables:

```env
# Convex Backend URL (from Step 1)
VITE_CONVEX_URL=https://happy-animal-123.convex.cloud

# Supabase
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key

# Google Drive
VITE_GOOGLE_DRIVE_API_KEY=your-google-drive-api-key

# Node Environment
NODE_ENV=production
```

### Step 3: Deploy Frontend to Railway

```bash
# Commit your code
git add .
git commit -m "Ready for deployment"
git push origin main

# Railway automatically:
# 1. Detects push
# 2. Runs: npm install
# 3. Runs: npm run build
# 4. Runs: npm start
# 5. Serves your app
```

## What Gets Deployed Where?

### Railway Deploys:
```
✅ src/components/
✅ src/pages/
✅ src/hooks/
✅ src/lib/
✅ public/
✅ index.html
✅ vite.config.ts
✅ package.json

❌ src/convex/ (NOT deployed to Railway)
```

### Convex Deploys:
```
✅ src/convex/auth.config.ts
✅ src/convex/auth.ts
✅ src/convex/http.ts
✅ src/convex/schema.ts
✅ src/convex/users.ts
✅ src/convex/auth/emailOtp.ts

❌ src/components/ (NOT deployed to Convex)
```

## Managing Updates

### When You Update Frontend Code:
```bash
# Just push to git
git add .
git commit -m "Update UI"
git push

# Railway auto-deploys
# No need to touch Convex
```

### When You Update Backend Code (src/convex/):
```bash
# 1. Deploy to Convex
convex deploy --prod

# 2. No need to redeploy Railway
# (unless you changed frontend too)
```

### When You Update Both:
```bash
# 1. Deploy Convex first
convex deploy --prod

# 2. Then push to Railway
git push
```

## Environment Variables Management

### Local Development (.env.local):
```env
# Auto-generated by convex dev
CONVEX_DEPLOYMENT=dev:your-dev-deployment
VITE_CONVEX_URL=https://your-dev-deployment.convex.cloud

# Add manually
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key
VITE_GOOGLE_DRIVE_API_KEY=your-google-drive-api-key
```

### Railway Production:
```env
# Use PRODUCTION Convex URL
VITE_CONVEX_URL=https://your-prod-deployment.convex.cloud

# Same for other services
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key
VITE_GOOGLE_DRIVE_API_KEY=your-google-drive-api-key
NODE_ENV=production
```

## Development vs Production

### Development:
```bash
# Terminal 1: Convex dev server
convex dev

# Terminal 2: React dev server
npm run dev

# Both running locally
# Convex URL: https://your-dev-deployment.convex.cloud
# React URL: http://localhost:5174
```

### Production:
```bash
# Convex: Deployed separately
convex deploy --prod
# URL: https://your-prod-deployment.convex.cloud

# Railway: Deployed via git push
git push
# URL: https://your-app.railway.app
```

## Convex Deployment Environments

Convex has two environments:

### Development:
- Created by: `convex dev`
- URL: `https://dev-deployment-123.convex.cloud`
- Use for: Local testing
- Data: Separate from production

### Production:
- Created by: `convex deploy --prod`
- URL: `https://prod-deployment-456.convex.cloud`
- Use for: Railway deployment
- Data: Separate from development

## Railway Build Process

When you push to Railway:

```bash
# 1. Install dependencies
npm install

# 2. Build React app
npm run build
# Creates: dist/ folder with static files

# 3. Start server
npm start
# Runs: vite preview --port $PORT --host 0.0.0.0
# Serves files from dist/

# 4. Railway assigns public URL
# https://your-app.railway.app
```

**Note:** Railway does NOT run `convex deploy`. You must do that separately.

## Checking Deployment Status

### Convex:
```bash
# Check current deployment
convex env

# View logs
convex logs

# Open dashboard
convex dashboard
```

### Railway:
- Check Railway dashboard
- View build logs
- View deploy logs
- Check environment variables

## Common Issues & Solutions

### Issue: "Convex connection failed"
**Cause:** Wrong `VITE_CONVEX_URL` in Railway

**Solution:**
1. Check Convex production URL: `convex env`
2. Update Railway variable: `VITE_CONVEX_URL`
3. Redeploy Railway

### Issue: "Functions not found"
**Cause:** Convex functions not deployed

**Solution:**
```bash
convex deploy --prod
```

### Issue: "Auth not working"
**Cause:** Using dev Convex URL in production

**Solution:**
- Use production URL in Railway
- Dev URL: `dev-deployment-123.convex.cloud`
- Prod URL: `prod-deployment-456.convex.cloud`

### Issue: "Changes not reflecting"
**Cause:** Deployed to wrong environment

**Solution:**
- Frontend changes: `git push` (Railway)
- Backend changes: `convex deploy --prod` (Convex)

## Deployment Checklist

### Initial Setup:
- [ ] Deploy Convex: `convex deploy --prod`
- [ ] Copy Convex production URL
- [ ] Add URL to Railway variables
- [ ] Add other environment variables
- [ ] Push to Railway: `git push`
- [ ] Test deployed app

### Regular Updates:
- [ ] Frontend only: `git push`
- [ ] Backend only: `convex deploy --prod`
- [ ] Both: Deploy Convex first, then push

## Cost Breakdown

### Convex:
- Free tier: 1M function calls/month
- Paid: $25/month for more

### Railway:
- Free tier: $5 credit/month
- Paid: Pay as you go

### Total for small app:
- Development: **FREE**
- Production (low traffic): **FREE** or ~$5-10/month

## Monitoring

### Convex Dashboard:
- Function calls
- Database queries
- Error logs
- Performance metrics

### Railway Dashboard:
- Build status
- Deploy logs
- Resource usage
- Custom domain setup

## Quick Reference

```bash
# Deploy Convex backend
convex deploy --prod

# Deploy Railway frontend
git push

# Check Convex status
convex env

# View Convex logs
convex logs

# Open Convex dashboard
convex dashboard
```

## Summary

**Railway manages:** Your React app (frontend)
**Convex manages:** Your backend functions
**They connect via:** Environment variable `VITE_CONVEX_URL`

Both are deployed **separately** but work together seamlessly.
